import logging
import time
import cflib.crtp
from cflib.crazyflie import Crazyflie
from cflib.crazyflie.syncCrazyflie import SyncCrazyflie
from cflib.positioning.position_hl_commander import PositionHlCommander
from cflib.utils import uri_helper
from cflib.utils.multiranger import Multiranger

uri = uri_helper.uri_from_env(default='radio://0/80/2M/E7E7E7E705')

MIN_DISTANCE = 0.35      # detection threshold 
SIDESTEP_DIST = 0.4      # sidestep distance 
FORWARD_BYPASS = 0.6     # forward distance during avoidance , aft sidestep move 0.4m

def detection(distance):
    """Return True if obstacle is closer than MIN_DISTANCE."""
    return distance is not None and distance < MIN_DISTANCE

def sequence():
    # Initialize and connect to Crazyflie
    with SyncCrazyflie(uri, cf=Crazyflie(rw_cache='./cache')) as scf:
        # Arm the Crazyflie
        scf.cf.platform.send_arming_request(True)
        time.sleep(1.0)

        # Enable Multiranger for obstacle sensing
        with Multiranger(scf) as ranger:
            with PositionHlCommander(
                scf,
                default_velocity=0.3,
                default_height=0.3,
                controller=PositionHlCommander.CONTROLLER_PID
            ) as pc:

                print("Starting mission...")
                time.sleep(1.0)

                # Waypoints to follow (in meters)
                waypoints = [
                    (0.8, 0.0),
                    (0.8, -0.8),
                    (-0.8, -0.8),
                    (-0.8, 0.8),
                    (0.8, 0.8),
                    (0.8, 0.0),
                    (0.0, 0.0)
                ]

                for (x, y) in waypoints:
                    print(f"Navigating to waypoint ({x}, {y})")

                    while True:
                        # Read distance sensors
                        front = ranger.front
                        back = ranger.back
                        left = ranger.left
                        right = ranger.right

                        # Obstacle avoidance logic
                        if detection(front):
                            print("Obstacle in Front! Avoiding...")
                            pc.left(SIDESTEP_DIST)
                            time.sleep(1.0)
                            pc.forward(FORWARD_BYPASS)
                            time.sleep(1.0)
                            pc.right(SIDESTEP_DIST)
                            time.sleep(1.0)

                        elif detection(back):
                            print("Obstacle Behind! Avoiding...")
                            pc.left(SIDESTEP_DIST)
                            time.sleep(1.0)
                            pc.back(FORWARD_BYPASS)
                            time.sleep(1.0)
                            pc.right(SIDESTEP_DIST)
                            time.sleep(1.0)

                        elif detection(left):
                            print("Obstacle to the Left! Avoiding...")
                            pc.right(SIDESTEP_DIST)
                            time.sleep(1.0)
                            pc.forward(FORWARD_BYPASS)
                            time.sleep(1.0)
                            pc.left(SIDESTEP_DIST)
                            time.sleep(1.0)

                        elif detection(right):
                            print("Obstacle to the Right! Avoiding...")
                            pc.left(SIDESTEP_DIST)
                            time.sleep(1.0)
                            pc.forward(FORWARD_BYPASS)
                            time.sleep(1.0)
                            pc.right(SIDESTEP_DIST)
                            time.sleep(1.0)

                        else:
                            # No obstacle detected - proceed to waypoint
                            print("Path clear, moving to waypoint.")
                            pc.go_to(x, y, 0.3)
                            break

                        # Give sensors time to update
                        time.sleep(0.1)

                    # Short pause after each waypoint
                    time.sleep(2.0)

                print("Mission complete. Landing...")
                pc.land()
                time.sleep(1.0)

if __name__ == "__main__":
    cflib.crtp.init_drivers(enable_debug_driver=False)
    sequence()
